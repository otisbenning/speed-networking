<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Networking - Caf√© Meet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .participants-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .participant {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .timer {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
            font-family: 'Courier New', monospace;
        }

        .timer.warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .partner-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .partner-name {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-card {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .question-card h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .question-card p {
            color: #856404;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .round-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #1976d2;
            font-weight: bold;
        }

        .bell-animation {
            font-size: 4em;
            animation: ring 0.5s ease-in-out 3;
        }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        .logout-btn {
            background: #dc3545;
            margin-top: 20px;
            padding: 10px;
            font-size: 14px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: left;
        }

        /* Chat Styles */
        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.own {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.other {
            background: #e9ecef;
            color: #333;
        }

        .chat-message .sender {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin: 0;
        }

        .chat-send-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: auto;
        }

        .chat-send-btn:hover {
            background: #5568d3;
        }

        /* Admin Panel Styles */
        .admin-section {
            margin: 20px 0;
            text-align: left;
        }

        .admin-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .questions-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .question-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-item button {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .locations-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .location-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-item button {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .save-btn {
            background: #28a745;
            margin-top: 10px;
        }

        .back-btn {
            background: #6c757d;
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Admin Login */
        .admin-login {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .admin-login h2 {
            color: #009892;
            margin-bottom: 30px;
            text-align: center;
        }

        .admin-login input[type="password"] {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .admin-login button {
            width: 100%;
            background: #009892;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-login button:hover {
            background: #007d77;
        }

        .error-message {
            color: #c30059;
            background: #ffe0eb;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        /* QR Code Container */
        .qr-code-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }

        .qr-code-display canvas {
            max-width: 100%;
            height: auto;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .pagination button {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            background: #009892;
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
            font-size: 14px;
        }

        /* Search Input */
        .search-input {
            margin-bottom: 15px;
        }

        .search-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Location Card */
        .location-card {
            background: white;
            border: 2px solid #009892;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .location-card h4 {
            color: #009892;
            margin-bottom: 15px;
        }

        .location-card .link-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-size: 12px;
            margin: 10px 0;
        }

        .copy-btn {
            background: #667eea;
            padding: 8px 15px;
            font-size: 13px;
            width: auto;
            margin-top: 10px;
        }

        /* Mobile Optimierung */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                max-width: 100%;
                margin: 10px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .partner-name {
                font-size: 1.5em;
            }
            
            .timer {
                font-size: 2.5em;
            }
            
            .admin-login {
                margin: 20px;
                padding: 25px;
            }
            
            .question-item,
            .location-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .question-item button,
            .location-item button {
                width: 100%;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Check-in Screen -->
        <div id="checkin-screen" class="screen">
            <h1>üéØ Speed Networking</h1>
            <p class="subtitle">Willkommen im Caf√© Meet!</p>
            
            <div class="info-box">
                <strong>So funktioniert's:</strong><br>
                ‚Ä¢ W√§hle deinen Standort<br>
                ‚Ä¢ Gib deinen Namen ein<br>
                ‚Ä¢ Alle Ger√§te piepen gleichzeitig<br>
                ‚Ä¢ Chatte mit deinem Gespr√§chspartner<br>
                ‚Ä¢ Nach <span id="duration-display">10</span> Minuten zur n√§chsten Person!
            </div>

            <div id="location-info" style="display: none; background: #009892; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold;">
                <span id="location-name"></span>
            </div>

            <input type="text" id="name-input" placeholder="Dein Name" maxlength="30">
            <button id="checkin-btn" onclick="checkIn()">Einchecken üì±</button>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <h1>‚è≥ Lobby</h1>
            <p class="subtitle">Warte auf andere Teilnehmer...</p>
            
            <div class="status-badge">‚úì Eingecheckt</div>
            <div class="status-badge" id="location-badge"></div>
            
            <div class="participants-list" id="participants-list"></div>
            
            <p style="color: #666; margin: 20px 0;">
                Die Runde startet automatisch, wenn mindestens 2 Personen eingecheckt sind.
            </p>
            
            <button class="logout-btn" onclick="logout()">Auschecken</button>
        </div>

        <!-- Matching Screen -->
        <div id="matching-screen" class="screen">
            <div class="bell-animation" id="bell">üîî</div>
            <h1>Es geht los!</h1>
            <p class="subtitle">Dein Gespr√§chspartner wartet...</p>
        </div>

        <!-- Conversation Screen -->
        <div id="conversation-screen" class="screen">
            <div class="round-info" id="round-info">Runde 1</div>
            
            <h2>Dein Gespr√§chspartner:</h2>
                    <button onclick="reportInactive()" style="background: #ffc107; font-size: 0.85em; padding: 8px 15px; margin-bottom: 10px;">
                ‚ö†Ô∏è Partner inaktiv melden
            </button>
            <div class="partner-card">
                <div class="partner-name" id="partner-name">---</div>
                <p>Viel Spa√ü beim Kennenlernen! üòä</p>
            </div>
            
            <div class="question-card">
                <h3>üí≠ Gespr√§chsthema:</h3>
                <p id="conversation-question">---</p>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" 
                           class="chat-input" 
                           id="chat-input" 
                           placeholder="Nachricht eingeben..." 
                           maxlength="200"
                           onkeypress="handleChatKeypress(event)">
                    <button class="chat-send-btn" onclick="sendChatMessage()">üì§</button>
                </div>
            </div>
            
            <div class="timer" id="timer">10:00</div>
            
            <button class="logout-btn" onclick="logout()">Auschecken</button>
        </div>

        <!-- Activity Check Screen -->
        <div id="activity-check-screen" class="screen">
            <div class="bell-animation">üîî</div>
            <h1>Bist du noch da?</h1>
            <p class="subtitle">Dein Gespr√§chspartner hat dich als inaktiv gemeldet.</p>
            
            <button onclick="confirmActivity()" style="background: #28a745;">
                ‚úì Ja, ich bin noch da!
            </button>
            
            <p style="color: #666; font-size: 0.9em; margin-top: 20px;">
                Wenn du nicht antwortest, musst du bei der n√§chsten Runde aussetzen.
            </p>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="screen">
            <h1>‚è∏Ô∏è Pause</h1>
            <p class="subtitle">Warte auf die n√§chste Runde...</p>
            
            <div class="participants-list" id="waiting-participants-list"></div>
            
            <p style="color: #666; margin: 20px 0;">
                Die n√§chste Runde beginnt gleich!
            </p>
            
            <button class="logout-btn" onclick="logout()">Auschecken</button>
        </div>

        <!-- Admin Login -->
        <div id="admin-login-screen" class="screen">
            <div class="admin-login">
                <h2>üîê Admin Login</h2>
                <div class="error-message" id="login-error">Falsches Passwort!</div>
                <input type="password" id="admin-password" placeholder="Admin-Passwort eingeben">
                <button onclick="adminLogin()">Anmelden</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-screen" class="screen">
            <h1>‚öôÔ∏è Admin Panel</h1>
            <p class="subtitle">Zentrale Verwaltung</p>

        <!-- Standort-Auswahl -->
        <div class="admin-section">
            <h3>üìç Standort ausw√§hlen</h3>
            <div class="form-group">
                <select id="admin-location-select" onchange="loadLocationSettings()">
                    <option value="">-- Standort w√§hlen --</option>
                </select>
            </div>
        </div>

        <!-- Standort-Details -->
        <div id="location-details" style="display: none;">
            <!-- Session Duration -->
            <div class="admin-section">
                <h3>‚è±Ô∏è Session-Dauer f√ºr diesen Standort</h3>
                <div class="form-group">
                    <label>Dauer pro Runde (Minuten)</label>
                    <select id="admin-duration">
                        <option value="1">1 Minute</option>
                        <option value="3">3 Minuten</option>
                        <option value="5">5 Minuten</option>
                        <option value="10" selected>10 Minuten</option>
                        <option value="15">15 Minuten</option>
                    </select>
                </div>
            </div>

            <!-- QR Code & Link -->
            <div class="admin-section">
                <h3>üîó Teilnehmer-Link & QR-Code</h3>
                <div class="location-card" id="location-link-card">
                    <div class="link-box" id="participant-link"></div>
                    <button class="copy-btn" onclick="copyParticipantLink()">üìã Link kopieren</button>
                    <div class="qr-code-display" id="qr-code-container"></div>
                </div>
            </div>

            <!-- Questions -->
            <div class="admin-section">
                <h3>üí≠ Gespr√§chsfragen f√ºr diesen Standort</h3>
                <div class="questions-list" id="questions-list"></div>
                <textarea id="new-question-input" placeholder="Neue Frage eingeben..."></textarea>
                <button onclick="addQuestionToLocation()">Frage hinzuf√ºgen</button>
                <button onclick="showQuestionLibrary()" style="background: #009892; margin-top: 5px;">üìö Aus Bibliothek w√§hlen</button>
            </div>

            <!-- Standorte Verwalten -->
            <div class="admin-section" style="border-top: 2px solid #e0e0e0; padding-top: 30px; margin-top: 30px;">
                <h3>üìç Standorte verwalten</h3>
                <div class="locations-list" id="locations-list"></div>
                <input type="text" id="new-location-input" placeholder="Neuer Standort...">
                <button onclick="addLocation()">Standort hinzuf√ºgen</button>
            </div>

            <button class="save-btn" onclick="saveAdminSettings()">üíæ Speichern</button>
            <button class="back-btn" onclick="adminLogout()">üö™ Logout</button>
        </div>
        <!-- Session Control -->
            <div class="admin-section" style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                <h3>üéÆ Session-Steuerung f√ºr diesen Standort</h3>
                <div id="session-status" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p><strong>Status:</strong> <span id="session-status-text">L√§dt...</span></p>
                    <p><strong>Teilnehmer:</strong> <span id="session-participants-count">0</span></p>
                    <p><strong>Aktuelle Runde:</strong> <span id="session-round-number">-</span></p>
                </div>
                <button id="start-session-btn" onclick="adminStartSession()" style="background: #28a745;">
                    üöÄ Session jetzt starten
                </button>
                <button id="stop-session-btn" onclick="adminStopSession()" style="background: #dc3545; margin-top: 10px;">
                    ‚èπÔ∏è Session beenden
                </button>
                <button id="auto-mode-btn" onclick="enableAutoMode()" style="background: #6c757d; margin-top: 10px; display: none;">
                    üîÑ Automatischen Modus aktivieren
                </button>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ‚ö†Ô∏è Im manuellen Modus startet die Session nur durch Admin-Klick.
                </p>
            </div>
    </div>

    <script>
        // DEBUG: Routing testen
        console.log('=== PAGE LOAD ===');
        console.log('URL:', window.location.href);
        console.log('Hash:', window.location.hash);
        console.log('Search:', window.location.search);

        // Sofortiger Admin-Check beim Laden
        if (window.location.hash === '#admin') {
            console.log('Admin hash detected on load!');
        }
        // Konfiguration
        const ADMIN_PASSWORD_HASH = 'swaf2024'; // TODO: In Produktion durch echten Hash ersetzen
        let isAdminAuthenticated = false;

        let config = {
            roundDuration: 10, // in Minuten
            locations: ['Caf√© Central', 'B√ºro Berlin', 'CoWorking K√∂ln'],
            questions: [
                "Was war dein bestes Erlebnis in den letzten 30 Tagen?",
                "Wenn du eine F√§higkeit sofort perfekt beherrschen k√∂nntest - welche w√§re es?",
                "Was ist deine Lieblings-Art, deine Freizeit zu verbringen?",
                "Welches Buch oder welcher Film hat dich zuletzt beeindruckt?",
                "Wenn du irgendwohin reisen k√∂nntest - wohin w√ºrdest du gehen?",
                "Was motiviert dich am meisten im Leben?",
                "Welche drei Dinge w√ºrdest du auf eine einsame Insel mitnehmen?",
                "Was war die beste Entscheidung, die du je getroffen hast?",
                "Wenn du ein Talent h√§ttest, das niemand kennt - welches w√§re es?",
                "Was steht ganz oben auf deiner Bucket List?"
            ]
        };

        let currentUser = null;
        let sessionActive = false;
        let currentLocation = null;
        let currentSessionId = null;
        let sessionStartLock = false;
        let currentRoundNumber = 0;
        let roundTimer = null;
        let syncInterval = null;
        let chatSyncInterval = null;
        let currentChatRoom = null;
        let visibilityCheckInterval = null;
        let lastVisibilityState = document.visibilityState;

        // Admin Login
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const errorMsg = document.getElementById('login-error');
            
            // TODO: In Produktion durch sichere Hash-Vergleich ersetzen
            if (password === ADMIN_PASSWORD_HASH) {
                isAdminAuthenticated = true;
                sessionStorage.setItem('adminAuth', 'true');
                showScreen('admin-screen');
                loadAdminSettings();
            } else {
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 3000);
            }
        }

        // Admin Auth Check
        function checkAdminAuth() {
            return sessionStorage.getItem('adminAuth') === 'true';
        }

        function initStorage() {
            // Config laden oder initialisieren
            const savedConfig = localStorage.getItem('appConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            } else {
                // Standort-spezifische Configs initialisieren
                const locationConfigs = {};
                config.locations.forEach(loc => {
                    locationConfigs[loc] = {
                        roundDuration: config.roundDuration,
                        questions: [...config.questions]
                    };
                });
                config.locationConfigs = locationConfigs;
                localStorage.setItem('appConfig', JSON.stringify(config));
            }
            // Participants pro Location
            if (!localStorage.getItem('participants')) {
                localStorage.setItem('participants', JSON.stringify({}));
            }
            // Session State pro Location
            if (!localStorage.getItem('sessionStates')) {
                localStorage.setItem('sessionStates', JSON.stringify({}));
            }
            // Chats
            if (!localStorage.getItem('chats')) {
                localStorage.setItem('chats', JSON.stringify({}));
            }
        }


        // Duration Display aktualisieren
        function updateDurationDisplay() {
            const display = document.getElementById('duration-display');
            if (display && currentLocation) {
                if (config.locationConfigs && config.locationConfigs[currentLocation]) {
                    display.textContent = config.locationConfigs[currentLocation].roundDuration;
                } else {
                    display.textContent = config.roundDuration;
                }
            }
        }

        // Admin Locations Select laden
        function loadAdminLocationsSelect() {
            const select = document.getElementById('admin-location-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Standort w√§hlen --</option>';
            config.locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                select.appendChild(option);
            });
        }


        // Check-in
        function checkIn() {
            const name = document.getElementById('name-input').value.trim();
            const location = currentLocation; // Bereits durch URL gesetzt
            
            if (!location) {
                alert('Fehler: Kein Standort festgelegt!');
                return;
            }

            if (!name) {
                alert('Bitte gib deinen Namen ein!');
                return;
            }

            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[location] || [];
            
            if (locationParticipants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Dieser Name ist bereits am Standort vergeben. Bitte w√§hle einen anderen Namen.');
                return;
            }

            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            currentUser = {
                id: userId,
                name: name,
                joinedAt: Date.now(),
                lastActivity: Date.now()
            };
            currentLocation = location;

            locationParticipants.push(currentUser);
            
            console.log('Checked in as:', currentUser.name, 'at location:', location);
            participants[location] = locationParticipants;
            localStorage.setItem('participants', JSON.stringify(participants));
            
            document.getElementById('location-badge').textContent = 'üìç ' + location;
            
            showScreen('lobby-screen');
            updateParticipantsList();
            startSync();
            startVisibilityCheck();
        }

        // Visibility Check - erkennt nur echtes Tab-Schlie√üen
        function startVisibilityCheck() {
            // Cleanup bei Page Unload (echter Tab-Schluss)
            window.addEventListener('beforeunload', handlePageUnload);
        }

        // Heartbeat aktualisieren
        function updateHeartbeat() {
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            
            const userIndex = locationParticipants.findIndex(p => p.id === currentUser.id);
            if (userIndex !== -1) {
                locationParticipants[userIndex].lastActivity = Date.now();
                participants[currentLocation] = locationParticipants;
                localStorage.setItem('participants', JSON.stringify(participants));
            }
        }

        // Partner als inaktiv melden
        function reportInactive() {
            if (!currentChatRoom) return;
            
            // Partner-ID aus dem aktuellen Match holen
            const sessionState = JSON.parse(localStorage.getItem('sessionState'));
            const currentRound = sessionState.currentRound;
            const myMatch = sessionState.matches[currentRound].find(m => m.partnerId === currentPartner.id || m.partnerId === currentUser.id);
            
            const partnerId = myMatch.partnerId === currentUser.id ? currentPartner.id : myMatch.partnerId;
            
            // Inaktiv-Meldung speichern
            const inactiveReports = JSON.parse(localStorage.getItem('inactiveReports') || '{}');
            if (!inactiveReports[partnerId]) {
                inactiveReports[partnerId] = [];
            }
            inactiveReports[partnerId].push({
                reportedBy: currentUser.id,
                timestamp: Date.now()
            });
            localStorage.setItem('inactiveReports', JSON.stringify(inactiveReports));
            
            alert('Partner wurde als inaktiv gemeldet. Er wird aufgefordert, seine Anwesenheit zu best√§tigen.');
        }

        // Aktivit√§ts-Check bei gemeldeten Usern
        function checkIfReported() {
            const inactiveReports = JSON.parse(localStorage.getItem('inactiveReports') || '{}');
            
            if (inactiveReports[currentUser.id] && inactiveReports[currentUser.id].length > 0) {
                // Wurde gemeldet - Best√§tigung anfordern
                showScreen('activity-check-screen');
                playNotificationSound();
            }
        }

        // User best√§tigt Aktivit√§t
        function confirmActivity() {
            // Meldungen l√∂schen
            const inactiveReports = JSON.parse(localStorage.getItem('inactiveReports') || '{}');
            delete inactiveReports[currentUser.id];
            localStorage.setItem('inactiveReports', JSON.stringify(inactiveReports));
            
            // Zur√ºck zum normalen Flow
            const sessionState = JSON.parse(localStorage.getItem('sessionState'));
            if (sessionState && sessionState.active) {
                checkSessionState();
            } else {
                showScreen('lobby-screen');
            }
        }

        // Gemeldete inaktive User aus Matching entfernen
        function removeReportedInactiveUsers() {
            const inactiveReports = JSON.parse(localStorage.getItem('inactiveReports') || '{}');
            const participants = JSON.parse(localStorage.getItem('participants'));
            
            Object.keys(participants).forEach(location => {
                participants[location] = participants[location].map(p => {
                    // Wenn User gemeldet wurde und nicht best√§tigt hat
                    if (inactiveReports[p.id] && inactiveReports[p.id].length > 0) {
                        const reportTime = inactiveReports[p.id][0].timestamp;
                        const now = Date.now();
                        
                        // Wenn Meldung √§lter als 30 Sekunden und keine Best√§tigung
                        if (now - reportTime > 30000) {
                            p.reportedInactive = true;
                        }
                    }
                    return p;
                });
            });
            
            localStorage.setItem('participants', JSON.stringify(participants));
        }

        // Page Unload - echter Tab-Schluss
        function handlePageUnload(e) {
            if (currentUser && currentLocation) {
                logout(true);
            }
        }


        // Synchronisation starten
        function startSync() {
            syncInterval = setInterval(() => {
                
                checkIfReported(); // Pr√ºfe ob User gemeldet wurde
                removeReportedInactiveUsers(); // Entferne nicht best√§tigte User
                
                const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
                const sessionState = sessionStates[currentLocation];
                
                // Pr√ºfe ob ich in den aktuellen Matches bin
                const amIInMatches = sessionState && 
                                     sessionState.matches && 
                                     sessionState.matches[currentUser.id] !== undefined;
                
                // Nur starten wenn: Session aktiv UND wir noch nicht aktiv sind UND wir in den Matches sind
                if (sessionState && sessionState.active && !sessionActive && amIInMatches) {
                    console.log('Session active and I am in matches, starting round...');
                    sessionActive = true;
                    startRound();
                } else if (sessionState && sessionState.active && !sessionActive && !amIInMatches) {
                    // Session l√§uft, aber ich bin nicht dabei ‚Üí Bleibe in Lobby
                    console.log('Session active but I am not in matches, staying in lobby...');
                    if (!document.getElementById('lobby-screen').classList.contains('active')) {
                        showScreen('lobby-screen');
                        updateParticipantsList();
                    }
                } else if ((!sessionState || !sessionState.active) && sessionActive) {
                    sessionActive = false;
                    showScreen('lobby-screen');
                    updateParticipantsList();
                }
                
                if (document.getElementById('lobby-screen').classList.contains('active')) {
                    updateParticipantsList();
                    checkStartConditions();
                }

                if (document.getElementById('waiting-screen').classList.contains('active')) {
                    updateWaitingParticipantsList();
                }
            }, 1000);
        }

        // Chat-Synchronisation starten
        function startChatSync() {
            chatSyncInterval = setInterval(() => {
                if (currentChatRoom) {
                    updateChatMessages();
                }
            }, 500);
        }

        // Chat-Synchronisation stoppen
        function stopChatSync() {
            if (chatSyncInterval) {
                clearInterval(chatSyncInterval);
                chatSyncInterval = null;
            }
        }

        // Chat-Nachricht senden
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatRoom) return;

            const chats = JSON.parse(localStorage.getItem('chats'));
            if (!chats[currentChatRoom]) {
                chats[currentChatRoom] = [];
            }

            const chatMessage = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                message: message,
                timestamp: Date.now()
            };
            
            console.log('Sending chat message:', chatMessage); // Debug-Zeile
            chats[currentChatRoom].push(chatMessage);

            localStorage.setItem('chats', JSON.stringify(chats));
            input.value = '';
            updateChatMessages();
        }

        // Enter-Taste im Chat
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Chat-Nachrichten aktualisieren
        function updateChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!currentChatRoom) return;

            const chats = JSON.parse(localStorage.getItem('chats'));
            const messages = chats[currentChatRoom] || [];

            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Noch keine Nachrichten. Sag Hallo! üëã</p>';
                return;
            }
            
            messages.forEach(msg => {
                console.log('Message:', msg.senderName, 'CurrentUser:', currentUser.name, 'IDs:', msg.senderId, currentUser.id); // Debug
                const isOwnMessage = msg.senderId === currentUser.id;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = isOwnMessage ? 'chat-message own' : 'chat-message other';
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'sender';
                senderDiv.textContent = isOwnMessage ? 'Du' : msg.senderName;
                
                const textDiv = document.createElement('div');
                textDiv.textContent = msg.message;
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(textDiv);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Chat l√∂schen
        function clearChat(chatRoom) {
            const chats = JSON.parse(localStorage.getItem('chats'));
            delete chats[chatRoom];
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        // Alle Chats f√ºr einen Standort l√∂schen
        function clearAllChatsForLocation(location) {
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[location] || [];
            const participantIds = locationParticipants.map(p => p.id);
            
            const chats = JSON.parse(localStorage.getItem('chats'));
            
            // Finde alle Chat-R√§ume, die zu diesem Standort geh√∂ren
            Object.keys(chats).forEach(chatRoom => {
                const roomUserIds = chatRoom.split('_');
                const belongsToLocation = roomUserIds.some(id => participantIds.includes(id));
                
                if (belongsToLocation) {
                    console.log('Deleting chat room:', chatRoom);
                    delete chats[chatRoom];
                }
            });
            
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        // Pr√ºfe Start-Bedingungen
        function checkStartConditions() {
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[currentLocation];
            
            // Wenn Session unter manueller Kontrolle ist, nicht automatisch starten
            if (sessionState && sessionState.manualControl) {
                return;
            }
            
            // Pr√ºfe ob ich der Coordinator bin (√§ltester User)
            const isCoordinator = locationParticipants.length > 0 && 
                                  locationParticipants[0].id === currentUser.id;
            
            if (isCoordinator && locationParticipants.length >= 2 && (!sessionState || !sessionState.active)) {
                // Lock setzen um doppelten Start zu verhindern
                if (sessionStartLock) {
                    console.log('Session start already in progress, skipping...');
                    return;
                }
                
                sessionStartLock = true;
                
                setTimeout(() => {
                    const currentParticipants = JSON.parse(localStorage.getItem('participants'));
                    const currentLocationParticipants = currentParticipants[currentLocation] || [];
                    const currentSessionStates = JSON.parse(localStorage.getItem('sessionStates'));
                    const currentSessionState = currentSessionStates[currentLocation];
                    
                    if (currentLocationParticipants.length >= 2 && 
                        (!currentSessionState || !currentSessionState.active) &&
                        currentLocationParticipants[0].id === currentUser.id) {
                        
                        console.log('Coordinator starting session:', currentUser.name);
                        startSession();
                    }
                    
                    sessionStartLock = false;
                }, 3000);
            }
        }

        // Session starten
        function startSession() {
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[currentLocation];
            
            // Verhindern von doppeltem Start
            if (sessionState && sessionState.active) {
                console.log('Session already active, aborting start');
                return;
            }
            
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            if (locationParticipants.length < 2) return;
            
            // Config neu laden um sicherzustellen, dass wir die aktuellste Dauer haben
            const savedConfig = localStorage.getItem('appConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }
            
            // Lade standort-spezifische Dauer
            const locationConfig = config.locationConfigs && config.locationConfigs[currentLocation] 
                ? config.locationConfigs[currentLocation] 
                : config;
            
            const matches = createMatches(locationParticipants);
            
            // Alte Chats f√ºr diesen Standort l√∂schen
            clearAllChatsForLocation(currentLocation);
            
            // Eindeutige Session-ID generieren
            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const newSessionState = {
                active: true,
                sessionId: sessionId,
                roundNumber: 1,
                roundStartTime: Date.now(),
                matches: matches,
                roundDuration: locationConfig.roundDuration  // Speichere Dauer im Session State
            };
            
            sessionStates[currentLocation] = newSessionState;
            localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
        }

        // Paarungen erstellen
        function createMatches(participants) {
            console.log('createMatches called with participants:', participants.map(p => p.name));
            
            // Markierte inaktive User rausfiltern
            const activeParticipants = participants.filter(p => !p.reportedInactive);
            
            const shuffled = [...activeParticipants].sort(() => Math.random() - 0.5);
            const matches = {};
            
            console.log('Shuffled order:', shuffled.map(p => p.name));
            
            for (let i = 0; i < shuffled.length; i += 2) {
                if (i + 1 < shuffled.length) {
                    const user1 = shuffled[i];
                    const user2 = shuffled[i + 1];
                    const chatRoomId = [user1.id, user2.id].sort().join('_');
                    
                    console.log(`Pairing: ${user1.name} <-> ${user2.name}`);
                    
                    matches[user1.id] = {
                        partnerId: user2.id,
                        partnerName: user2.name,
                        chatRoom: chatRoomId
                    };
                    matches[user2.id] = {
                        partnerId: user1.id,
                        partnerName: user1.name,
                        chatRoom: chatRoomId
                    };
                } else {
                    console.log(`${shuffled[i].name} hat keinen Partner (ungerade Anzahl)`);
                    matches[shuffled[i].id] = {
                        partnerId: null,
                        partnerName: null,
                        chatRoom: null
                    };
                }
            }
            
            return matches;
        }

        // Runde starten
        function startRound() {
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[currentLocation];
            
            // Pr√ºfen ob Session-ID sich ge√§ndert hat (neue Session vom Admin)
            if (currentSessionId && sessionState.sessionId !== currentSessionId) {
                console.log('New session detected, resetting round counter...');
                currentSessionId = sessionState.sessionId;
                currentRoundNumber = 0;  // WICHTIG: Reset bei neuer Session!
                stopChatSync();
                if (currentChatRoom) {
                    clearChat(currentChatRoom);
                    currentChatRoom = null;
                }
            } else if (!currentSessionId) {
                currentSessionId = sessionState.sessionId;
            }
            
            // Verhindern von mehrfachem Aufruf derselben Runde
            if (currentRoundNumber === sessionState.roundNumber) {
                console.log('Round already started, skipping...', sessionState.roundNumber);
                return;
            }
            
            currentRoundNumber = sessionState.roundNumber;
            console.log('Starting round:', currentRoundNumber, 'of session:', currentSessionId);
            
            showScreen('matching-screen');
            playNotificationSound();
            
            setTimeout(() => {
                const match = sessionState.matches[currentUser.id];
                
                console.log('My match:', match);
                
                // Validiere dass das Match symmetrisch ist
                if (match && match.partnerId) {
                    const partnerMatch = sessionState.matches[match.partnerId];
                    console.log('Partner match:', partnerMatch);
                    
                    if (partnerMatch && partnerMatch.partnerId !== currentUser.id) {
                        console.error('ASYMMETRIC MATCH DETECTED!', 
                                      'My partner:', match.partnerName, 
                                      'Their partner:', partnerMatch.partnerName);
                        alert('Fehler bei der Paarung erkannt! Bitte Admin informieren.');
                        return;
                    }
                    
                    currentChatRoom = match.chatRoom;
                    
                    document.getElementById('round-info').textContent = `Runde ${sessionState.roundNumber}`;
                    document.getElementById('partner-name').textContent = match.partnerName;
                    const locationConfig = config.locationConfigs && config.locationConfigs[currentLocation] 
                        ? config.locationConfigs[currentLocation] 
                        : config;
                    const questions = locationConfig.questions || config.questions;
                    document.getElementById('conversation-question').textContent = 
                        questions[Math.floor(Math.random() * questions.length)];
                    
                    document.getElementById('chat-messages').innerHTML = '';
                    document.getElementById('chat-input').value = '';
                    
                    showScreen('conversation-screen');
                    startTimer(sessionState.roundStartTime);
                    startChatSync();
                    updateChatMessages();
                } else {
                    // Kein Partner in dieser Runde
                    currentChatRoom = null;
                    showScreen('waiting-screen');
                    updateWaitingParticipantsList();
                    
                    console.log('No partner for this round, waiting...');
                    
                    // Berechne verbleibende Zeit basierend auf roundDuration im sessionState
                    const roundDuration = sessionState.roundDuration || 10;
                    const timeLeft = roundDuration * 60 * 1000 - (Date.now() - sessionState.roundStartTime);
                    
                    console.log('Time left until next round:', Math.round(timeLeft / 1000), 'seconds');
                    
                    if (timeLeft > 0) {
                        setTimeout(() => {
                            checkForNextRound();
                        }, timeLeft);
                    } else {
                        // Zeit ist schon abgelaufen, sofort zur n√§chsten Runde
                        checkForNextRound();
                    }
                }
            }, 2000);
        }

        // Timer starten
        function startTimer(startTime) {
            const timerElement = document.getElementById('timer');
            
            // Lade Dauer aus dem Session State (wurde beim Start gespeichert)
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[currentLocation];
            const roundDuration = sessionState && sessionState.roundDuration 
                ? sessionState.roundDuration 
                : (config.locationConfigs && config.locationConfigs[currentLocation] 
                    ? config.locationConfigs[currentLocation].roundDuration 
                    : config.roundDuration);
            
            console.log('Timer Start - Location:', currentLocation);
            console.log('Session State roundDuration:', sessionState?.roundDuration);
            console.log('Config roundDuration:', config.locationConfigs?.[currentLocation]?.roundDuration);
            console.log('Using roundDuration:', roundDuration, 'minutes');
            
            const ROUND_DURATION = roundDuration * 60 * 1000;
            function updateTimer() {
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, ROUND_DURATION - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                timerElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (remaining < 60000) {
                    timerElement.classList.add('warning');
                } else {
                    timerElement.classList.remove('warning');
                }
                
                if (remaining === 0) {
                    clearInterval(roundTimer);
                    stopChatSync();
                    
                    // Chat l√∂schen
                    if (currentChatRoom) {
                        clearChat(currentChatRoom);
                        currentChatRoom = null;
                    }
                    
                    checkForNextRound();
                }
            }
            
            updateTimer();
            roundTimer = setInterval(updateTimer, 100);
        }


        // N√§chste Runde pr√ºfen
        function checkForNextRound() {
            console.log('checkForNextRound called for user:', currentUser.name);
            
            // Warte kurz damit alle Clients den Timer beenden
            setTimeout(() => {
                const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
                const sessionState = sessionStates[currentLocation];
                
                // Hole FRISCHE Teilnehmerliste
                const participants = JSON.parse(localStorage.getItem('participants'));
                const locationParticipants = participants[currentLocation] || [];
                
                console.log('Participants for next round:', locationParticipants.map(p => p.name));
                
                if (locationParticipants.length < 2) {
                    endSession();
                    return;
                }
                
                // Pr√ºfe ob ich der Coordinator bin
                const isCoordinator = locationParticipants.length > 0 && 
                                      locationParticipants[0].id === currentUser.id;
                
                console.log('Is coordinator?', isCoordinator, 'User:', currentUser.name);
                
                if (isCoordinator) {
                    // Pr√ºfe ob schon jemand die n√§chste Runde erstellt hat
                    const currentSessionStates = JSON.parse(localStorage.getItem('sessionStates'));
                    const currentSessionState = currentSessionStates[currentLocation];
                    
                    if (currentSessionState.roundNumber > sessionState.roundNumber) {
                        console.log('Next round already created by another client');
                        return;
                    }
                    
                    // NOCHMAL frische Teilnehmerliste holen (sicher ist sicher!)
                    const finalParticipants = JSON.parse(localStorage.getItem('participants'));
                    const finalLocationParticipants = finalParticipants[currentLocation] || [];
                    
                    console.log('Coordinator creating matches for', finalLocationParticipants.length, 'participants:', 
                                finalLocationParticipants.map(p => p.name));
                    
                    const matches = createMatches(finalLocationParticipants);
                    
                    // Debug: Log alle Matches
                    Object.keys(matches).forEach(userId => {
                        const match = matches[userId];
                        const userName = finalLocationParticipants.find(p => p.id === userId)?.name;
                        console.log(`Match: ${userName} (${userId}) <-> ${match.partnerName} (${match.partnerId})`);
                    });
                    
                    const newSessionState = {
                        active: true,
                        sessionId: sessionState.sessionId,
                        roundNumber: sessionState.roundNumber + 1,
                        roundStartTime: Date.now(),
                        matches: matches,
                        roundDuration: sessionState.roundDuration,
                        manualControl: sessionState.manualControl
                    };
                    
                    currentSessionStates[currentLocation] = newSessionState;
                    localStorage.setItem('sessionStates', JSON.stringify(currentSessionStates));
                    
                    console.log('Next round created:', newSessionState.roundNumber);
                }
                
                // Reset f√ºr alle Teilnehmer
                currentRoundNumber = 0;
                
                // WICHTIG: sessionActive muss HIER auf false bleiben
                // Der syncInterval wird es auf true setzen wenn die neue Runde bereit ist
                sessionActive = false;
                
                console.log('Round transition complete, waiting for sync to trigger next round...');
                
            }, 1000);
        }


        // Session beenden
        function endSession() {
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            sessionStates[currentLocation] = {
                active: false,
                roundNumber: 0,
                roundStartTime: null,
                matches: {}
            };
            localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
            sessionActive = false;
            currentRoundNumber = 0;
            stopChatSync();
            showScreen('lobby-screen');
            updateParticipantsList();
        }

        // Teilnehmerliste aktualisieren
        function updateParticipantsList() {
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            const listElement = document.getElementById('participants-list');
            
            if (locationParticipants.length === 0) {
                listElement.innerHTML = '<p style="color: #999;">Noch keine Teilnehmer...</p>';
            } else {
                listElement.innerHTML = locationParticipants
                    .map(p => `<div class="participant">${p.name}</div>`)
                    .join('');
            }
        }

        // Wartende Teilnehmerliste aktualisieren
        function updateWaitingParticipantsList() {
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            const listElement = document.getElementById('waiting-participants-list');
            
            listElement.innerHTML = locationParticipants
                .map(p => `<div class="participant">${p.name}</div>`)
                .join('');
        }

        // Logout
        function logout(skipConfirm = false) {
            if (!skipConfirm && !confirm('M√∂chtest du dich wirklich auschecken?')) {
                return;
            }
            
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[currentLocation] || [];
            participants[currentLocation] = locationParticipants.filter(p => p.id !== currentUser.id);
            localStorage.setItem('participants', JSON.stringify(participants));
            
            clearInterval(syncInterval);
            clearInterval(roundTimer);
            clearInterval(visibilityCheckInterval);
            stopChatSync();
            
            if (currentChatRoom) {
                clearChat(currentChatRoom);
            }
            
            window.removeEventListener('beforeunload', handlePageUnload);
            
            currentUser = null;
            currentLocation = null;
            sessionActive = false;
            currentChatRoom = null;
            currentRoundNumber = 0;
            
            showScreen('checkin-screen');
            document.getElementById('name-input').value = '';
            document.getElementById('location-select').selectedIndex = 0;
        }

        // Admin Panel Navigation
        function showAdminPanel() {
            console.log('showAdminPanel called, Auth:', checkAdminAuth());
            if (checkAdminAuth()) {
                showScreen('admin-screen');
                loadAdminSettings();
            } else {
                showScreen('admin-login-screen');
            }
        }

        function closeAdminPanel() {
            window.location.href = window.location.pathname;
        }

        function adminLogout() {
            sessionStorage.removeItem('adminAuth');
            isAdminAuthenticated = false;
            stopAdminStatusUpdates();
            window.location.href = window.location.pathname;
        }

        function loadAdminSettings() {
            loadAdminLocationsSelect();
            
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = config.locations.map((loc, idx) => `
                <div class="location-item">
                    <span>${loc}</span>
                    <button onclick="removeLocation(${idx})">üóëÔ∏è</button>
                </div>
            `).join('');
            
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = config.questions.map((q, idx) => `
                <div class="question-item">
                    <span>${q}</span>
                    <button onclick="removeQuestion(${idx})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function addLocation() {
            const input = document.getElementById('new-location-input');
            const location = input.value.trim();
            
            if (!location) {
                alert('Bitte gib einen Standort ein!');
                return;
            }
            
            if (config.locations.includes(location)) {
                alert('Dieser Standort existiert bereits!');
                return;
            }
            
            config.locations.push(location);
            input.value = '';
            loadAdminSettings();
        }

        function removeLocation(index) {
            if (confirm('M√∂chtest du diesen Standort wirklich l√∂schen?')) {
                config.locations.splice(index, 1);
                loadAdminSettings();
            }
        }

        function addQuestion() {
            const input = document.getElementById('new-question-input');
            const question = input.value.trim();
            
            if (!question) {
                alert('Bitte gib eine Frage ein!');
                return;
            }
            
            config.questions.push(question);
            input.value = '';
            loadAdminSettings();
        }

        function removeQuestion(index) {
            if (confirm('M√∂chtest du diese Frage wirklich l√∂schen?')) {
                config.questions.splice(index, 1);
                loadAdminSettings();
            }
        }

        // Standort-spezifische Einstellungen laden
        function loadLocationSettings() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            const locationDetails = document.getElementById('location-details');
            
            if (!selectedLocation) {
                if (locationDetails) {
                    locationDetails.style.display = 'none';
                }
                stopAdminStatusUpdates();
                return;
            }
            
            // Details-Sektion anzeigen
            if (locationDetails) {
                locationDetails.style.display = 'block';
            }
            
            // Sicherstellen, dass locationConfigs existiert
            if (!config.locationConfigs) {
                config.locationConfigs = {};
            }
            
            // Config f√ºr Standort laden oder initialisieren
            if (!config.locationConfigs[selectedLocation]) {
                config.locationConfigs[selectedLocation] = {
                    roundDuration: config.roundDuration,
                    questions: [...config.questions]
                };
            }
            
            const locationConfig = config.locationConfigs[selectedLocation];
            document.getElementById('admin-duration').value = locationConfig.roundDuration;
            loadQuestionsList(locationConfig.questions);

            // Teilnehmer-Link generieren
            generateParticipantLink(selectedLocation);
                        
            // QR-Code anzeigen
            displayQRCode(selectedLocation);
            
            // Session-Status aktualisieren
            startAdminStatusUpdates();
        }


        // Fragen-Liste laden
        function loadQuestionsList(questions) {
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = questions.map((q, idx) => `
                <div class="question-item">
                    <span>${q}</span>
                    <button onclick="removeLocationQuestion(${idx})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        // Standort-spezifische Frage entfernen
        function removeLocationQuestion(index) {
            const selectedLocation = document.getElementById('admin-location-select').value;
            if (!selectedLocation) {
                if (confirm('M√∂chtest du diese Frage wirklich aus der Gesamt-Bibliothek l√∂schen?')) {
                    config.questions.splice(index, 1);
                    loadQuestionsList(config.questions);
                }
                return;
            }
            
            if (confirm('M√∂chtest du diese Frage f√ºr diesen Standort entfernen?')) {
                config.locationConfigs[selectedLocation].questions.splice(index, 1);
                loadQuestionsList(config.locationConfigs[selectedLocation].questions);
            }
        }

        // Frage hinzuf√ºgen (angepasst)
        function addQuestionToLocation() {
            const input = document.getElementById('new-question-input');
            const question = input.value.trim();
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!question) {
                alert('Bitte gib eine Frage ein!');
                return;
            }
            
            // Zur Gesamt-Bibliothek hinzuf√ºgen
            if (!config.questions.includes(question)) {
                config.questions.push(question);
            }
            
            // Zur Standort-Config hinzuf√ºgen
            if (selectedLocation) {
                if (!config.locationConfigs[selectedLocation].questions.includes(question)) {
                    config.locationConfigs[selectedLocation].questions.push(question);
                }
                loadQuestionsList(config.locationConfigs[selectedLocation].questions);
            } else {
                loadQuestionsList(config.questions);
            }
            
            input.value = '';
        }

        // Teilnehmer-Link generieren
        function generateParticipantLink(location) {
            const baseUrl = window.location.origin + window.location.pathname;
            const participantUrl = `${baseUrl}?location=${encodeURIComponent(location)}`;
            
            console.log('Generating participant link for:', location);
            console.log('URL:', participantUrl);
            
            const linkElement = document.getElementById('participant-link');
            if (linkElement) {
                linkElement.textContent = participantUrl;
                console.log('Link set successfully');
            } else {
                console.error('participant-link element not found!');
            }
        }

        // Link kopieren
        function copyParticipantLink() {
            const link = document.getElementById('participant-link').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link kopiert! ‚úì');
            });
        }

        // QR-Code anzeigen
        function displayQRCode(location) {
            const container = document.getElementById('qr-code-container');
            container.innerHTML = ''; // Clear previous QR code
            
            const baseUrl = window.location.origin + window.location.pathname;
            const participantUrl = `${baseUrl}?location=${encodeURIComponent(location)}`;
            
            new QRCode(container, {
                text: participantUrl,
                width: 200,
                height: 200,
                colorDark: "#009892",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Fragen-Bibliothek anzeigen
        function showQuestionLibrary() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            if (!selectedLocation) {
                alert('Bitte w√§hle zuerst einen Standort aus!');
                return;
            }
            
            const libraryHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üìö Fragen-Bibliothek</h4>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">W√§hle Fragen aus der Gesamt-Bibliothek:</p>
                    ${config.questions.map((q, idx) => {
                        const isUsed = config.locationConfigs[selectedLocation].questions.includes(q);
                        return `
                            <div style="background: white; padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 13px;">${q}</span>
                                <button onclick="addQuestionFromLibrary(${idx})" 
                                        style="padding: 4px 10px; font-size: 11px; ${isUsed ? 'opacity: 0.5;' : ''}"
                                        ${isUsed ? 'disabled' : ''}>
                                    ${isUsed ? '‚úì Verwendet' : '+ Hinzuf√ºgen'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            const existingLibrary = document.getElementById('question-library');
            if (existingLibrary) {
                existingLibrary.remove();
            }
            
            const questionsList = document.getElementById('questions-list');
            questionsList.insertAdjacentHTML('afterend', `<div id="question-library">${libraryHTML}</div>`);
        }

        function addQuestionFromLibrary(index) {
            const selectedLocation = document.getElementById('admin-location-select').value;
            const question = config.questions[index];
            
            if (!config.locationConfigs[selectedLocation].questions.includes(question)) {
                config.locationConfigs[selectedLocation].questions.push(question);
                loadQuestionsList(config.locationConfigs[selectedLocation].questions);
                showQuestionLibrary(); // Refresh library
            }
        }

        // Fragen-Bibliothek mit Suche und Pagination
        let libraryCurrentPage = 1;
        let librarySearchTerm = '';
        const ITEMS_PER_PAGE = 10;

        function showQuestionLibrary() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            if (!selectedLocation) {
                alert('Bitte w√§hle zuerst einen Standort aus!');
                return;
            }
            
            libraryCurrentPage = 1;
            librarySearchTerm = '';
            renderQuestionLibrary();
        }

        function renderQuestionLibrary() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            // Filter questions based on search term
            let filteredQuestions = config.questions.filter(q => 
                q.toLowerCase().includes(librarySearchTerm.toLowerCase())
            );
            
            const totalPages = Math.ceil(filteredQuestions.length / ITEMS_PER_PAGE);
            const startIndex = (libraryCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const questionsToShow = filteredQuestions.slice(startIndex, endIndex);
            
            const libraryHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üìö Fragen-Bibliothek</h4>
                    
                    <div class="search-input">
                        <input type="text" 
                            id="library-search" 
                            placeholder="Fragen durchsuchen..." 
                            value="${librarySearchTerm}"
                            oninput="handleLibrarySearch(event)">
                    </div>
                    
                    <p class="search-result-count" style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ${filteredQuestions.length} Fragen gefunden
                    </p>
                    
                    <div class="library-questions-list">
                        ${questionsToShow.map((q) => {
                            const actualIndex = config.questions.indexOf(q);
                            const isUsed = config.locationConfigs[selectedLocation].questions.includes(q);
                            return `
                                <div style="background: white; padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                    <span style="font-size: 13px; flex: 1;">${q}</span>
                                    <button onclick="addQuestionFromLibrary(${actualIndex})" 
                                            style="padding: 4px 10px; font-size: 11px; ${isUsed ? 'opacity: 0.5;' : ''}"
                                            ${isUsed ? 'disabled' : ''}>
                                        ${isUsed ? '‚úì Verwendet' : '+ Hinzuf√ºgen'}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="library-pagination pagination" style="${totalPages > 1 ? '' : 'display: none;'}">
                        <button onclick="changeLibraryPage(-1)" ${libraryCurrentPage === 1 ? 'disabled' : ''}>
                            ‚óÄ Zur√ºck
                        </button>
                        <span>Seite ${libraryCurrentPage} von ${totalPages}</span>
                        <button onclick="changeLibraryPage(1)" ${libraryCurrentPage === totalPages ? 'disabled' : ''}>
                            Weiter ‚ñ∂
                        </button>
                    </div>
                    
                    <button onclick="closeQuestionLibrary()" style="background: #6c757d; margin-top: 10px; width: 100%;">
                        Schlie√üen
                    </button>
                </div>
            `;
            
            const existingLibrary = document.getElementById('question-library');
            if (existingLibrary) {
                existingLibrary.innerHTML = libraryHTML;
            } else {
                const questionsList = document.getElementById('questions-list');
                questionsList.insertAdjacentHTML('afterend', `<div id="question-library">${libraryHTML}</div>`);
            }
            
            // Fokus zur√ºck auf Suchfeld setzen
            setTimeout(() => {
                const searchInput = document.getElementById('library-search');
                if (searchInput && document.activeElement !== searchInput) {
                    searchInput.focus();
                    // Cursor ans Ende setzen
                    searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
                }
            }, 0);
        }

        function handleLibrarySearch(event) {
            librarySearchTerm = event.target.value;
            libraryCurrentPage = 1;
            
            // Update nur den Inhalt, nicht das komplette HTML
            updateQuestionLibraryContent();
        }

        function updateQuestionLibraryContent() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            // Filter questions based on search term
            let filteredQuestions = config.questions.filter(q => 
                q.toLowerCase().includes(librarySearchTerm.toLowerCase())
            );
            
            const totalPages = Math.ceil(filteredQuestions.length / ITEMS_PER_PAGE);
            const startIndex = (libraryCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const questionsToShow = filteredQuestions.slice(startIndex, endIndex);
            
            // Nur den Fragen-Container und Pagination aktualisieren
            const library = document.getElementById('question-library');
            if (!library) return;
            
            // Update result count
            const resultCount = library.querySelector('.search-result-count');
            if (resultCount) {
                resultCount.textContent = `${filteredQuestions.length} Fragen gefunden`;
            }
            
            // Update questions list
            const questionsList = library.querySelector('.library-questions-list');
            if (questionsList) {
                questionsList.innerHTML = questionsToShow.map((q) => {
                    const actualIndex = config.questions.indexOf(q);
                    const isUsed = config.locationConfigs[selectedLocation].questions.includes(q);
                    return `
                        <div style="background: white; padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                            <span style="font-size: 13px; flex: 1;">${q}</span>
                            <button onclick="addQuestionFromLibrary(${actualIndex})" 
                                    style="padding: 4px 10px; font-size: 11px; ${isUsed ? 'opacity: 0.5;' : ''}"
                                    ${isUsed ? 'disabled' : ''}>
                                ${isUsed ? '‚úì Verwendet' : '+ Hinzuf√ºgen'}
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // Update pagination
            const pagination = library.querySelector('.library-pagination');
            if (pagination) {
                if (totalPages > 1) {
                    pagination.innerHTML = `
                        <button onclick="changeLibraryPage(-1)" ${libraryCurrentPage === 1 ? 'disabled' : ''}>
                            ‚óÄ Zur√ºck
                        </button>
                        <span>Seite ${libraryCurrentPage} von ${totalPages}</span>
                        <button onclick="changeLibraryPage(1)" ${libraryCurrentPage === totalPages ? 'disabled' : ''}>
                            Weiter ‚ñ∂
                        </button>
                    `;
                    pagination.style.display = 'flex';
                } else {
                    pagination.style.display = 'none';
                }
            }
        }

        function changeLibraryPage(direction) {
            libraryCurrentPage += direction;
            updateQuestionLibraryContent();
        }

        function closeQuestionLibrary() {
            const library = document.getElementById('question-library');
            if (library) {
                library.remove();
            }
        }

        // Admin: Session manuell starten
        function adminStartSession() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!selectedLocation) {
                alert('Bitte w√§hle zuerst einen Standort aus!');
                return;
            }
            
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[selectedLocation] || [];
            
            if (locationParticipants.length < 2) {
                alert('Mindestens 2 Teilnehmer erforderlich um eine Session zu starten!');
                return;
            }
            
            // Config neu laden
            const savedConfig = localStorage.getItem('appConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }
            
            // Hole aktuelle Dauer
            const locationConfig = config.locationConfigs && config.locationConfigs[selectedLocation] 
                ? config.locationConfigs[selectedLocation] 
                : config;
            const currentDuration = locationConfig.roundDuration || config.roundDuration;
            
            if (!confirm(`Session f√ºr ${selectedLocation} jetzt starten?\n\nDauer pro Runde: ${currentDuration} Minuten`)) {
                return;
            }
            
            const matches = createMatches(locationParticipants);
            
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const existingState = sessionStates[selectedLocation];
            
            // Verwende die Session-ID vom Stop, oder generiere eine neue
            const sessionId = (existingState && existingState.sessionId) 
                ? existingState.sessionId 
                : 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            sessionStates[selectedLocation] = {
                active: true,
                sessionId: sessionId,  // √úbernehme oder erstelle Session-ID
                roundNumber: 1,
                roundStartTime: Date.now(),
                matches: matches,
                manualControl: true,  // Aktiviert manuellen Kontrollmodus
                roundDuration: currentDuration  // Speichere die aktuelle Dauer
            };
            
            localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
            
            alert('Session gestartet! ‚úì');
            updateSessionStatus();
        }

        // Admin: Session stoppen
        function adminStopSession() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!selectedLocation) {
                alert('Bitte w√§hle zuerst einen Standort aus!');
                return;
            }
            
            if (!confirm(`Session f√ºr ${selectedLocation} wirklich beenden?`)) {
                return;
            }
            
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            
            // Generiere neue Session-ID damit Clients erkennen dass es eine neue Session sein wird
            const newSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            sessionStates[selectedLocation] = {
                active: false,
                sessionId: newSessionId,  // WICHTIG: Neue Session-ID!
                roundNumber: 0,
                roundStartTime: null,
                matches: {},
                manualControl: true  // Bleibt im manuellen Modus
            };
            
            localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
            
            // Alle Chats f√ºr diesen Standort l√∂schen
            const chats = JSON.parse(localStorage.getItem('chats'));
            Object.keys(chats).forEach(chatRoom => {
                // Pr√ºfen ob Chat zu diesem Standort geh√∂rt
                const participants = JSON.parse(localStorage.getItem('participants'));
                const locationParticipants = participants[selectedLocation] || [];
                const participantIds = locationParticipants.map(p => p.id);
                
                if (chatRoom.split('_').some(id => participantIds.includes(id))) {
                    delete chats[chatRoom];
                }
            });
            localStorage.setItem('chats', JSON.stringify(chats));
            
            alert('Session beendet! ‚úì');
            updateSessionStatus();
        }

        // Session-Status im Admin Panel aktualisieren
        function updateSessionStatus() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!selectedLocation) {
                document.getElementById('session-status-text').textContent = 'Kein Standort gew√§hlt';
                document.getElementById('session-participants-count').textContent = '0';
                document.getElementById('session-round-number').textContent = '-';
                document.getElementById('start-session-btn').disabled = true;
                document.getElementById('stop-session-btn').disabled = true;
                return;
            }
            
            const participants = JSON.parse(localStorage.getItem('participants'));
            const locationParticipants = participants[selectedLocation] || [];
            
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[selectedLocation];
            
            document.getElementById('session-participants-count').textContent = locationParticipants.length;
            
            const isManualControl = sessionState && sessionState.manualControl;
            
            if (sessionState && sessionState.active) {
                const modeText = isManualControl ? ' (Manuell)' : ' (Auto)';
                const durationText = sessionState.roundDuration ? ' - ' + sessionState.roundDuration + ' Min/Runde' : '';
                document.getElementById('session-status-text').innerHTML = '<span style="color: #28a745; font-weight: bold;">üü¢ Aktiv' + modeText + durationText + '</span>';
                document.getElementById('session-round-number').textContent = sessionState.roundNumber || '-';
                document.getElementById('start-session-btn').disabled = true;
                document.getElementById('stop-session-btn').disabled = false;
                document.getElementById('auto-mode-btn').style.display = 'none';
            } else {
                const modeText = isManualControl ? ' (Manueller Modus)' : ' (Automatischer Modus)';
                document.getElementById('session-status-text').innerHTML = '<span style="color: #666;">‚ö´ Inaktiv' + modeText + '</span>';
                document.getElementById('session-round-number').textContent = '-';
                document.getElementById('start-session-btn').disabled = locationParticipants.length < 2;
                document.getElementById('stop-session-btn').disabled = true;
                
                // Zeige Auto-Mode Button nur wenn im manuellen Modus
                if (isManualControl) {
                    document.getElementById('auto-mode-btn').style.display = 'block';
                } else {
                    document.getElementById('auto-mode-btn').style.display = 'none';
                }
            }
        }

        // Intervall f√ºr automatische Status-Aktualisierung im Admin Panel
        let adminStatusInterval = null;
        
        function startAdminStatusUpdates() {
            if (adminStatusInterval) {
                clearInterval(adminStatusInterval);
            }
            updateSessionStatus();
            adminStatusInterval = setInterval(updateSessionStatus, 2000);
        }
        
        function stopAdminStatusUpdates() {
            if (adminStatusInterval) {
                clearInterval(adminStatusInterval);
                adminStatusInterval = null;
            }
        }

        // Automatischen Modus wieder aktivieren
        function enableAutoMode() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!selectedLocation) {
                alert('Bitte w√§hle zuerst einen Standort aus!');
                return;
            }
            
            if (!confirm(`Automatischen Start-Modus f√ºr ${selectedLocation} aktivieren?\n\nDie Session wird automatisch starten wenn >= 2 Teilnehmer da sind.`)) {
                return;
            }
            
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const currentState = sessionStates[selectedLocation] || {};
            
            sessionStates[selectedLocation] = {
                ...currentState,
                manualControl: false
            };
            
            localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
            
            alert('Automatischer Modus aktiviert! ‚úì\n\nDie Session startet automatisch bei >= 2 Teilnehmern.');
            updateSessionStatus();
        }

        function saveAdminSettings() {
            const selectedLocation = document.getElementById('admin-location-select').value;
            
            if (!selectedLocation) {
                alert('Bitte w√§hle einen Standort aus!');
                return;
            }
            
            const newDuration = parseInt(document.getElementById('admin-duration').value);
            
            if (config.locationConfigs[selectedLocation]) {
                config.locationConfigs[selectedLocation].roundDuration = newDuration;
            }
            
            localStorage.setItem('appConfig', JSON.stringify(config));
            
            // Pr√ºfe ob eine Session f√ºr diesen Standort l√§uft
            const sessionStates = JSON.parse(localStorage.getItem('sessionStates'));
            const sessionState = sessionStates[selectedLocation];
            
            if (sessionState && sessionState.active) {
                // Aktualisiere die Dauer auch f√ºr die laufende Session
                sessionState.roundDuration = newDuration;
                sessionStates[selectedLocation] = sessionState;
                localStorage.setItem('sessionStates', JSON.stringify(sessionStates));
                
                alert('Einstellungen f√ºr ' + selectedLocation + ' gespeichert! ‚úì\n\n‚ö†Ô∏è Hinweis: Die neue Dauer (' + newDuration + ' Min) gilt ab der AKTUELLEN Runde.\nDie Timer bei den Teilnehmern zeigen noch die alte Restzeit an, aber die n√§chste Runde verwendet die neue Dauer.');
            } else {
                alert('Einstellungen f√ºr ' + selectedLocation + ' gespeichert! ‚úì\n\nDie neue Dauer (' + newDuration + ' Min) wird bei der n√§chsten Session verwendet.');
            }
            
            updateSessionStatus();
        }

        // Bildschirm wechseln
        function showScreen(screenId) {
            console.log('showScreen called with:', screenId);
            
            const targetScreen = document.getElementById(screenId);
            if (!targetScreen) {
                console.error('Screen not found:', screenId);
                return;
            }
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            targetScreen.classList.add('active');
            console.log('Active screen is now:', screenId);
        }

        // Benachrichtigungston
        function playNotificationSound() {
            const bell = document.getElementById('bell');
            bell.style.display = 'block';
            setTimeout(() => {
                bell.style.display = 'none';
            }, 1500);
            
            if ('AudioContext' in window || 'webkitAudioContext' in window) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioCtx = new AudioContext();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
        }

        // Initialisierung und Routing
        window.addEventListener('load', () => {
            initStorage();
            handleRouting();
        });

        // Hash-√Ñnderungen abfangen (f√ºr Navigation)
        window.addEventListener('hashchange', () => {
            handleRouting();
        });

        // Routing-Logik
        function handleRouting() {
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedLocation = urlParams.get('location');
            const hash = window.location.hash;

            console.log('Routing Debug - Hash:', hash, 'Admin Param:', urlParams.get('admin'), 'Location:', preselectedLocation);

            // Admin Route
            if (hash === '#admin' || urlParams.get('admin') === 'true') {
                console.log('Navigating to admin panel');
                if (checkAdminAuth()) {
                    showScreen('admin-screen');
                    loadAdminSettings();
                } else {
                    showScreen('admin-login-screen');
                }
                return; // Wichtig: Stoppt weitere Ausf√ºhrung
            } 
            // Teilnehmer-Modus mit vorausgew√§hltem Standort
            else if (preselectedLocation && config.locations.includes(preselectedLocation)) {
                console.log('Setting up participant mode for location:', preselectedLocation);
                currentLocation = preselectedLocation;
                const locationInfo = document.getElementById('location-info');
                const locationName = document.getElementById('location-name');
                if (locationInfo && locationName) {
                    locationInfo.style.display = 'block';
                    locationName.textContent = 'üìç ' + preselectedLocation;
                }
                updateDurationDisplay();
                showScreen('checkin-screen');
            } 

            // Kein Standort gew√§hlt
            else if (!preselectedLocation && hash !== '#admin') {
                console.log('No location selected');
                showScreen('checkin-screen');
                setTimeout(() => {
                    alert('Bitte verwende den Link, den du von deinem Organisator erhalten hast.');
                }, 500);
            }
        }
    </script>
</body>
</html>
